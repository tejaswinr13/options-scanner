<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Analysis - {{ symbol }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header-section {
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #ff6600;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .options-header {
            text-align: center;
        }

        .options-symbol {
            font-size: 3rem;
            font-weight: bold;
            color: #ff6600;
            margin-bottom: 10px;
        }

        .options-title {
            font-size: 1.5rem;
            color: #ccc;
            margin-bottom: 20px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
        }

        .analytics-card h5 {
            color: #ff6600;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #222;
        }

        .metric-label {
            color: #ccc;
            font-weight: 500;
        }

        .metric-value {
            color: #fff;
            font-weight: bold;
        }

        .expiration-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .expiration-tab {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .expiration-tab:hover {
            background: #555;
        }

        .expiration-tab.active {
            background: #ff6600;
            color: #000;
            border-color: #ff6600;
        }

        .options-table-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #333;
            margin-bottom: 30px;
        }

        .options-table {
            width: 100%;
            border-collapse: collapse;
        }

        .options-table th {
            background: rgba(255, 102, 0, 0.1);
            border-bottom: 2px solid #ff6600;
            padding: 12px 8px;
            font-weight: bold;
            color: #ff6600;
            font-size: 0.9rem;
            text-align: center;
        }

        .options-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #333;
            text-align: center;
            font-size: 0.85rem;
        }

        .options-table tr:hover {
            background: rgba(255, 102, 0, 0.05);
        }

        .call-option {
            border-left: 3px solid #00ff00;
        }

        .put-option {
            border-left: 3px solid #ff4444;
        }

        .itm {
            background: rgba(255, 215, 0, 0.1);
        }

        .otm {
            background: rgba(128, 128, 128, 0.1);
        }

        .high-volume {
            background: rgba(255, 102, 0, 0.2);
        }

        .loading {
            text-align: center;
            color: #ff6600;
            font-size: 1.2rem;
            padding: 40px;
        }

        .error {
            text-align: center;
            color: #ff4444;
            font-size: 1.2rem;
            padding: 40px;
        }

        .back-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #555;
            color: #fff;
            text-decoration: none;
        }

        .unusual-activity {
            background: rgba(255, 102, 0, 0.05);
            border-left: 4px solid #ff6600;
        }

        .flow-analysis {
            background: rgba(0, 255, 0, 0.05);
            border-left: 4px solid #00ff00;
        }

        .greeks-summary {
            background: rgba(0, 170, 255, 0.05);
            border-left: 4px solid #00aaff;
        }

        @media (max-width: 768px) {
            .options-symbol {
                font-size: 2rem;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .expiration-tabs {
                justify-content: flex-start;
            }
            
            .options-table {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <a href="/stock/{{ symbol }}" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Stock Analysis
                </a>
            </div>
        </div>

        <div class="header-section">
            <div class="options-header">
                <div class="options-symbol" id="optionsSymbol">{{ symbol }}</div>
                <div class="options-title">Options Chain Analysis</div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <i class="fas fa-spinner fa-spin"></i> Loading options data...
        </div>

        <div class="error" id="errorIndicator" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> Error loading options data. Please try again.
        </div>

        <div id="optionsContent" style="display: none;">
            <!-- Analytics Summary -->
            <div class="analytics-grid">
                <!-- Flow Analysis -->
                <div class="analytics-card flow-analysis">
                    <h5><i class="fas fa-chart-line"></i> Options Flow</h5>
                    <div class="metric-row">
                        <span class="metric-label">Total Call Volume:</span>
                        <span class="metric-value" id="totalCallVolume">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Total Put Volume:</span>
                        <span class="metric-value" id="totalPutVolume">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Put/Call Ratio:</span>
                        <span class="metric-value" id="putCallRatio">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Max Pain:</span>
                        <span class="metric-value" id="maxPain">-</span>
                    </div>
                </div>

                <!-- Open Interest -->
                <div class="analytics-card">
                    <h5><i class="fas fa-chart-bar"></i> Open Interest</h5>
                    <div class="metric-row">
                        <span class="metric-label">Total Call OI:</span>
                        <span class="metric-value" id="totalCallOI">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Total Put OI:</span>
                        <span class="metric-value" id="totalPutOI">-</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">OI Put/Call Ratio:</span>
                        <span class="metric-value" id="oiPutCallRatio">-</span>
                    </div>
                </div>

                <!-- Most Active Strikes -->
                <div class="analytics-card">
                    <h5><i class="fas fa-fire"></i> Most Active Strikes</h5>
                    <div id="mostActiveStrikes">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Unusual Activity -->
                <div class="analytics-card unusual-activity">
                    <h5><i class="fas fa-exclamation-circle"></i> Unusual Activity</h5>
                    <div id="unusualActivity">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Expiration Tabs -->
            <div class="expiration-tabs" id="expirationTabs">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Options Chain Tables -->
            <div id="optionsChainContainer">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        const symbol = '{{ symbol }}';
        let optionsData = {};
        let currentExpiration = null;

        // Load options data
        async function loadOptionsData() {
            try {
                const response = await fetch(`/api/options/chain/${symbol}`);
                const data = await response.json();
                
                if (data.error) {
                    showError();
                    return;
                }
                
                optionsData = data;
                populateAnalytics();
                createExpirationTabs();
                
                // Load first expiration by default
                if (data.expirations && data.expirations.length > 0) {
                    loadExpiration(data.expirations[0]);
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Error loading options data:', error);
                showError();
            }
        }

        function populateAnalytics() {
            const analytics = optionsData.analytics || {};
            
            // Flow analysis
            document.getElementById('totalCallVolume').textContent = formatNumber(analytics.total_call_volume || 0);
            document.getElementById('totalPutVolume').textContent = formatNumber(analytics.total_put_volume || 0);
            document.getElementById('putCallRatio').textContent = (analytics.put_call_ratio || 0).toFixed(2);
            document.getElementById('maxPain').textContent = `$${(analytics.max_pain || 0).toFixed(2)}`;
            
            // Open interest
            document.getElementById('totalCallOI').textContent = formatNumber(analytics.total_call_oi || 0);
            document.getElementById('totalPutOI').textContent = formatNumber(analytics.total_put_oi || 0);
            
            const oiRatio = analytics.total_call_oi > 0 ? 
                (analytics.total_put_oi / analytics.total_call_oi).toFixed(2) : '0.00';
            document.getElementById('oiPutCallRatio').textContent = oiRatio;
            
            // Most active strikes
            populateMostActiveStrikes(analytics.most_active_strikes || []);
            
            // Unusual activity
            populateUnusualActivity(analytics.unusual_activity || []);
        }

        function populateMostActiveStrikes(strikes) {
            const container = document.getElementById('mostActiveStrikes');
            container.innerHTML = '';
            
            if (strikes.length === 0) {
                container.innerHTML = '<div class="metric-row"><span class="metric-label">No data available</span></div>';
                return;
            }
            
            strikes.slice(0, 5).forEach(strike => {
                const row = document.createElement('div');
                row.className = 'metric-row';
                row.innerHTML = `
                    <span class="metric-label">$${strike.strike}</span>
                    <span class="metric-value">${formatNumber(strike.volume)}</span>
                `;
                container.appendChild(row);
            });
        }

        function populateUnusualActivity(activity) {
            const container = document.getElementById('unusualActivity');
            container.innerHTML = '';
            
            if (activity.length === 0) {
                container.innerHTML = '<div class="metric-row"><span class="metric-label">No unusual activity detected</span></div>';
                return;
            }
            
            activity.slice(0, 5).forEach(item => {
                const row = document.createElement('div');
                row.className = 'metric-row';
                const typeColor = item.type === 'call' ? '#00ff00' : '#ff4444';
                row.innerHTML = `
                    <span class="metric-label">$${item.strike} ${item.type.toUpperCase()}</span>
                    <span class="metric-value" style="color: ${typeColor}">${formatNumber(item.volume)}</span>
                `;
                container.appendChild(row);
            });
        }

        function createExpirationTabs() {
            const container = document.getElementById('expirationTabs');
            container.innerHTML = '';
            
            optionsData.expirations.forEach((expiration, index) => {
                const tab = document.createElement('div');
                tab.className = `expiration-tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = formatExpirationDate(expiration);
                tab.onclick = () => loadExpiration(expiration);
                container.appendChild(tab);
            });
        }

        function loadExpiration(expiration) {
            currentExpiration = expiration;
            
            // Update active tab
            document.querySelectorAll('.expiration-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent === formatExpirationDate(expiration)) {
                    tab.classList.add('active');
                }
            });
            
            // Load options chain for this expiration
            const chainData = optionsData.chains[expiration];
            if (chainData) {
                displayOptionsChain(chainData);
            }
        }

        function displayOptionsChain(chainData) {
            const container = document.getElementById('optionsChainContainer');
            container.innerHTML = '';
            
            // Create calls table
            if (chainData.calls && chainData.calls.length > 0) {
                const callsTable = createOptionsTable('Calls', chainData.calls, 'call');
                container.appendChild(callsTable);
            }
            
            // Create puts table
            if (chainData.puts && chainData.puts.length > 0) {
                const putsTable = createOptionsTable('Puts', chainData.puts, 'put');
                container.appendChild(putsTable);
            }
        }

        function createOptionsTable(title, options, type) {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'options-table-container';
            
            const titleElement = document.createElement('h5');
            titleElement.style.color = type === 'call' ? '#00ff00' : '#ff4444';
            titleElement.style.padding = '15px';
            titleElement.style.margin = '0';
            titleElement.innerHTML = `<i class="fas fa-${type === 'call' ? 'arrow-up' : 'arrow-down'}"></i> ${title}`;
            
            const table = document.createElement('table');
            table.className = 'options-table';
            
            // Create header
            const header = document.createElement('thead');
            header.innerHTML = `
                <tr>
                    <th>Strike</th>
                    <th>Last</th>
                    <th>Bid</th>
                    <th>Ask</th>
                    <th>Volume</th>
                    <th>OI</th>
                    <th>IV</th>
                    <th>Delta</th>
                    <th>Gamma</th>
                    <th>Theta</th>
                    <th>Vega</th>
                </tr>
            `;
            
            // Create body
            const body = document.createElement('tbody');
            options.forEach(option => {
                const row = document.createElement('tr');
                const isITM = type === 'call' ? 
                    option.strike < optionsData.current_price : 
                    option.strike > optionsData.current_price;
                
                row.className = `${type}-option ${isITM ? 'itm' : 'otm'} ${option.volume > 1000 ? 'high-volume' : ''}`;
                
                row.innerHTML = `
                    <td><strong>$${option.strike}</strong></td>
                    <td>$${(option.lastPrice || 0).toFixed(2)}</td>
                    <td>$${(option.bid || 0).toFixed(2)}</td>
                    <td>$${(option.ask || 0).toFixed(2)}</td>
                    <td>${formatNumber(option.volume || 0)}</td>
                    <td>${formatNumber(option.openInterest || 0)}</td>
                    <td>${((option.impliedVolatility || 0) * 100).toFixed(1)}%</td>
                    <td>${(option.delta || 0).toFixed(3)}</td>
                    <td>${(option.gamma || 0).toFixed(4)}</td>
                    <td>${(option.theta || 0).toFixed(3)}</td>
                    <td>${(option.vega || 0).toFixed(3)}</td>
                `;
                
                body.appendChild(row);
            });
            
            table.appendChild(header);
            table.appendChild(body);
            tableContainer.appendChild(titleElement);
            tableContainer.appendChild(table);
            
            return tableContainer;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function formatExpirationDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
            });
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('optionsContent').style.display = 'block';
        }

        function showError() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorIndicator').style.display = 'block';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadOptionsData();
        });
    </script>
</body>
</html>
