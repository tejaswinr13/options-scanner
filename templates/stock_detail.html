<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis - {{ symbol }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header-section {
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #00ff00;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .header-section .analysis-section {
            margin-top: 15px;
        }

        .header-section .analysis-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #00ff00;
        }

        .fundamental-analysis-detailed {
            color: #fff;
        }

        .fundamental-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #ffa500;
        }

        .fundamental-section h6 {
            color: #ffa500;
            margin-bottom: 15px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        .fundamental-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .fundamental-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #222;
        }

        .fundamental-item .label {
            color: #ccc;
            font-weight: 500;
        }

        .fundamental-item .value {
            color: #fff;
            font-weight: bold;
        }

        .recommendation-card {
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recommendation-score {
            color: #aaa;
            font-size: 0.9em;
        }

        .top-nav {
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #00ff00;
            border-radius: 25px;
            padding: 8px 20px;
            color: #fff;
            width: 300px;
            font-size: 14px;
        }

        .search-box:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-box::placeholder {
            color: #aaa;
        }

        .nav-brand {
            color: #00ff00;
            font-weight: bold;
            text-decoration: none;
            font-size: 18px;
        }

        .nav-brand:hover {
            color: #00ff00;
            text-decoration: none;
        }

        .stock-header {
            text-align: center;
        }

        .stock-symbol {
            font-size: 3rem;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 10px;
        }

        .stock-name {
            font-size: 1.5rem;
            color: #ccc;
            margin-bottom: 20px;
        }

        .price-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .current-price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffffff;
        }

        .price-change {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .price-change.positive {
            color: #00ff00;
        }

        .price-change.negative {
            color: #ff4444;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
        }

        .info-card h5 {
            color: #00ff00;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #222;
        }

        .info-label {
            color: #ccc;
            font-weight: 500;
        }

        .info-value {
            color: #fff;
            font-weight: bold;
        }

        .range-bar {
            width: 100%;
            height: 20px;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa00 50%, #00ff00 100%);
            border-radius: 10px;
            position: relative;
            margin: 10px 0;
        }

        .range-indicator {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 30px;
            background: #ffffff;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .volume-analytics {
            background: rgba(0, 255, 0, 0.05);
            border-left: 4px solid #00ff00;
        }

        .technical-indicators {
            background: rgba(0, 170, 255, 0.05);
            border-left: 4px solid #00aaff;
        }

        .price-statistics {
            background: rgba(255, 170, 0, 0.05);
            border-left: 4px solid #ffaa00;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-btn:hover {
            background: #555;
        }

        .chart-btn.active {
            background: #00ff00;
            color: #000;
            border-color: #00ff00;
        }

        .chart-type-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            color: #00ff00;
            font-size: 1.2rem;
            padding: 40px;
        }

        .error {
            text-align: center;
            color: #ff4444;
            font-size: 1.2rem;
            padding: 40px;
        }

        .back-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #555;
            color: #fff;
            text-decoration: none;
        }

        .news-item {
            border-bottom: 1px solid #333;
            padding: 12px 0;
            margin-bottom: 12px;
        }

        .news-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .news-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
            line-height: 1.3;
            font-size: 0.95em;
        }

        .news-title a {
            color: #ffffff;
            text-decoration: none;
        }

        .news-title a:hover {
            color: #00ff00;
            text-decoration: underline;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.8em;
        }

        .news-source {
            color: #888;
        }

        .news-date {
            color: #aaa;
        }

        .news-summary {
            color: #ccc;
            font-size: 0.85em;
            line-height: 1.4;
            margin-bottom: 6px;
        }

        .sentiment-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .sentiment-positive {
            background-color: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .sentiment-negative {
            background-color: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .sentiment-neutral {
            background-color: rgba(136, 136, 136, 0.2);
            color: #888;
        }

        .news-expanded {
            max-height: 600px;
            overflow-y: auto;
        }

        .news-collapsed {
            max-height: 300px;
            overflow: hidden;
        }

        .technical-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .technical-indicator:last-child {
            border-bottom: none;
        }

        .indicator-label {
            color: #ccc;
            font-size: 0.9em;
        }

        .indicator-value {
            color: #fff;
            font-weight: 600;
        }

        .signal-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .signal-buy {
            background-color: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .signal-sell {
            background-color: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .signal-neutral {
            background-color: rgba(136, 136, 136, 0.2);
            color: #888;
        }

        .pattern-detected {
            background-color: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            margin: 2px;
            display: inline-block;
        }

        .forecast-item {
            background-color: #2a2a2a;
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
        }

        .technical-expanded {
            max-height: none;
        }

        .technical-collapsed {
            max-height: 200px;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .stock-symbol {
                font-size: 2rem;
            }
            
            .current-price {
                font-size: 2rem;
            }
            
            .price-change {
                font-size: 1.2rem;
            }
            
            .price-display {
                flex-direction: column;
                gap: 10px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="search-container">
                        <a href="/dashboard" class="nav-brand">
                            <i class="fas fa-chart-line"></i> Stock Dashboard
                        </a>
                        <div class="ms-auto d-flex align-items-center">
                            <input type="text" 
                                   class="search-box" 
                                   id="stockSearch" 
                                   placeholder="Search stocks (e.g., AAPL, TSLA, MSFT...)"
                                   autocomplete="off">
                            <button class="btn btn-outline-success ms-2" onclick="searchStock()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <a href="/dashboard" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <div class="header-section">
            <div class="stock-header">
                <div class="stock-symbol" id="stockSymbol">{{ symbol }}</div>
                <div class="stock-name" id="stockName">Loading...</div>
                <div class="price-display">
                    <div class="current-price" id="currentPrice">$0.00</div>
                    <div class="price-change" id="priceChange">+$0.00 (0.00%)</div>
                </div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <i class="fas fa-spinner fa-spin"></i> Loading comprehensive stock data...
        </div>

        <div class="error" id="errorIndicator" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> Error loading stock data. Please try again.
        </div>

        <div id="stockContent" style="display: none;">
            <!-- Chart Section -->
            <div class="chart-container">
                <h5 style="color: #00ff00; text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-chart-line"></i> Price Chart
                </h5>
                
                <div class="chart-type-controls">
                    <button class="chart-btn" onclick="setChartType('line')" id="lineChartBtn">
                        <i class="fas fa-chart-line"></i> Line
                    </button>
                    <button class="chart-btn active" onclick="setChartType('candlestick')" id="candlestickChartBtn">
                        <i class="fas fa-chart-bar"></i> Candlestick
                    </button>
                </div>
                
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="loadChart('1d', this)">1D</button>
                    <button class="chart-btn" onclick="loadChart('3d', this)">3D</button>
                    <button class="chart-btn" onclick="loadChart('5d', this)">5D</button>
                    <button class="chart-btn" onclick="loadChart('15d', this)">15D</button>
                    <button class="chart-btn" onclick="loadChart('1mo', this)">1M</button>
                    <button class="chart-btn" onclick="loadChart('3mo', this)">3M</button>
                    <button class="chart-btn" onclick="loadChart('6mo', this)">6M</button>
                    <button class="chart-btn" onclick="loadChart('ytd', this)">YTD</button>
                    <button class="chart-btn" onclick="loadChart('1y', this)">1Y</button>
                    <button class="chart-btn" onclick="loadChart('2y', this)">2Y</button>
                    <button class="chart-btn" onclick="loadChart('5y', this)">5Y</button>
                    <button class="chart-btn" onclick="loadChart('max', this)">MAX</button>
                </div>
                
                <div id="priceChart" style="height: 400px; width: 100%;"></div>
            </div>

            <!-- Information Grid -->
            <div class="info-grid">
                <!-- Basic Information -->
                <div class="info-card">
                    <h5><i class="fas fa-info-circle"></i> Basic Information</h5>
                    <div class="info-row">
                        <span class="info-label">Sector:</span>
                        <span class="info-value" id="sector">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Industry:</span>
                        <span class="info-value" id="industry">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Market Cap:</span>
                        <span class="info-value" id="marketCap">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">P/E Ratio:</span>
                        <span class="info-value" id="peRatio">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Beta:</span>
                        <span class="info-value" id="beta">-</span>
                    </div>
                </div>

                <!-- Market Information -->
                <div class="info-card">
                    <h5><i class="fas fa-building"></i> Market Info</h5>
                    <div class="info-row">
                        <span class="info-label">Exchange:</span>
                        <span class="info-value" id="exchange">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Currency:</span>
                        <span class="info-value" id="currency">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Timezone:</span>
                        <span class="info-value" id="timezone">-</span>
                    </div>
                </div>

                <!-- Options Summary -->
                <div class="info-card">
                    <h5><i class="fas fa-coins"></i> Options Overview</h5>
                    <div id="optionsSummary">
                        <div class="loading-text">Loading options data...</div>
                    </div>
                    <div class="mt-3">
                        <a href="/options/{{ symbol }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-external-link-alt"></i> Full Options Analysis
                        </a>
                    </div>
                </div>

                <!-- News Summary -->
                <div class="info-card">
                    <h5><i class="fas fa-newspaper"></i> Recent News</h5>
                    <div id="newsSummary">
                        <div class="loading-text">Loading news...</div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-info btn-sm" onclick="toggleNewsExpanded()">
                            <i class="fas fa-expand"></i> <span id="newsToggleText">Show All News</span>
                        </button>
                    </div>
                </div>

                <!-- Technical Analysis -->
                <div class="info-card">
                    <div class="analysis-section" id="technicalAnalysisSection" style="display: none;">
                        <div class="analysis-content" id="technicalAnalysisContent">
                            <div class="loading-spinner">Loading technical analysis...</div>
                        </div>
                    </div>
                </div>

                <!-- Fundamental Analysis Section -->
                <div class="tile" onclick="toggleFundamentalAnalysis()">
                    <div class="tile-header">
                        <h3><i class="fas fa-chart-bar"></i> Fundamental Analysis</h3>
                        <span class="expand-icon" id="fundamentalExpandIcon">+</span>
                    </div>
                    <div class="tile-content">
                        <div class="analysis-preview" id="fundamentalAnalysisPreview">
                            <div class="metric-row">
                                <span class="metric-label">P/E Ratio:</span>
                                <span class="metric-value" id="fundamentalPE">Loading...</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ROE:</span>
                                <span class="metric-value" id="fundamentalROE">Loading...</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Revenue Growth:</span>
                                <span class="metric-value" id="fundamentalGrowth">Loading...</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Recommendation:</span>
                                <span class="metric-value" id="fundamentalRating">Loading...</span>
                            </div>
                        </div>
                        <div class="analysis-section" id="fundamentalAnalysisSection" style="display: none;">
                            <div class="analysis-content" id="fundamentalAnalysisContent">
                                <div class="loading-spinner">Loading fundamental analysis...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Ranges -->
                <div class="info-card">
                    <h5><i class="fas fa-chart-area"></i> Price Ranges</h5>
                    <div class="info-row">
                        <span class="info-label">Day Range:</span>
                        <span class="info-value" id="dayRange">-</span>
                    </div>
                    <div class="range-bar">
                        <div class="range-indicator" id="dayRangeIndicator"></div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">52-Week Range:</span>
                        <span class="info-value" id="fiftyTwoWeekRange">-</span>
                    </div>
                    <div class="range-bar">
                        <div class="range-indicator" id="fiftyTwoWeekRangeIndicator"></div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Previous Close:</span>
                        <span class="info-value" id="previousClose">-</span>
                    </div>
                </div>

                <!-- Volume Analytics -->
                <div class="info-card volume-analytics">
                    <h5><i class="fas fa-chart-bar"></i> Volume Analytics</h5>
                    <div class="info-row">
                        <span class="info-label">Current Volume:</span>
                        <span class="info-value" id="currentVolume">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">5-Day Avg:</span>
                        <span class="info-value" id="volume5DayAvg">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">30-Day Avg:</span>
                        <span class="info-value" id="volume30DayAvg">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">3-Month Avg:</span>
                        <span class="info-value" id="volume3MonthAvg">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Volume Trend:</span>
                        <span class="info-value" id="volumeTrend">-</span>
                    </div>
                </div>

                <!-- Technical Indicators -->
                <div class="info-card technical-indicators">
                    <h5><i class="fas fa-chart-line"></i> Technical Indicators</h5>
                    <div class="info-row">
                        <span class="info-label">RSI (14):</span>
                        <span class="info-value" id="rsi">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">MACD:</span>
                        <span class="info-value" id="macd">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">SMA 20:</span>
                        <span class="info-value" id="sma20">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">SMA 50:</span>
                        <span class="info-value" id="sma50">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">VWAP:</span>
                        <span class="info-value" id="vwap">-</span>
                    </div>
                </div>

                <!-- Price Statistics -->
                <div class="info-card price-statistics">
                    <h5><i class="fas fa-percentage"></i> Performance</h5>
                    <div class="info-row">
                        <span class="info-label">1-Day:</span>
                        <span class="info-value" id="perf1Day">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">5-Day:</span>
                        <span class="info-value" id="perf5Day">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">1-Month:</span>
                        <span class="info-value" id="perf1Month">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">3-Month:</span>
                        <span class="info-value" id="perf3Month">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">1-Year:</span>
                        <span class="info-value" id="perf1Year">-</span>
                    </div>
                </div>

                <!-- Additional Volume Details -->
                <div class="info-card volume-analytics">
                    <h5><i class="fas fa-chart-column"></i> Volume Details</h5>
                    <div class="info-row">
                        <span class="info-label">10-Day Avg:</span>
                        <span class="info-value" id="volume10DayAvg">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">15-Day Avg:</span>
                        <span class="info-value" id="volume15DayAvg">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">6-Month Avg:</span>
                        <span class="info-value" id="volume6MonthAvg">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">1-Year Avg:</span>
                        <span class="info-value" id="volume1YearAvg">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">30-Day Ratio:</span>
                        <span class="info-value" id="volume30DayRatio">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const symbol = '{{ symbol }}';
        let stockData = {};
        let currentChart = null;
        let currentTimeframe = '5d';
        let currentChartType = 'candlestick';
        let chart = null;

        // Load comprehensive stock data
        async function loadStockData() {
            try {
                const response = await fetch(`/api/stock/comprehensive/${symbol}`);
                const data = await response.json();
                
                if (data.error) {
                    showError();
                    return;
                }
                
                stockData = data;
                populateStockInfo();
                loadChart(currentTimeframe);
                hideLoading();
                
            } catch (error) {
                console.error('Error loading stock data:', error);
                showError();
            }
        }

        function populateStockInfo() {
            // Basic info
            document.getElementById('stockName').textContent = stockData.name || symbol;
            document.getElementById('currentPrice').textContent = `$${stockData.current_price?.toFixed(2) || '0.00'}`;
            
            // Price change
            const change = stockData.current_price - stockData.previous_close;
            const changePercent = (change / stockData.previous_close) * 100;
            const changeElement = document.getElementById('priceChange');
            const changeSign = change >= 0 ? '+' : '';
            changeElement.textContent = `${changeSign}$${change.toFixed(2)} (${changePercent.toFixed(2)}%)`;
            changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
            
            // Basic information
            document.getElementById('sector').textContent = stockData.sector || '-';
            document.getElementById('industry').textContent = stockData.industry || '-';
            document.getElementById('marketCap').textContent = formatMarketCap(stockData.market_cap);
            document.getElementById('peRatio').textContent = stockData.pe_ratio?.toFixed(2) || '-';
            document.getElementById('beta').textContent = stockData.beta?.toFixed(2) || '-';
            document.getElementById('previousClose').textContent = `$${stockData.previous_close?.toFixed(2) || '0.00'}`;
            
            // Market information
            document.getElementById('exchange').textContent = stockData.exchange || '-';
            document.getElementById('currency').textContent = stockData.currency || 'USD';
            document.getElementById('timezone').textContent = stockData.timezone || 'EST';
            
            // Price ranges
            document.getElementById('dayRange').textContent = 
                `$${stockData.day_low?.toFixed(2) || '0.00'} - $${stockData.day_high?.toFixed(2) || '0.00'}`;
            document.getElementById('fiftyTwoWeekRange').textContent = 
                `$${stockData.fifty_two_week_low?.toFixed(2) || '0.00'} - $${stockData.fifty_two_week_high?.toFixed(2) || '0.00'}`;
            
            // Range indicators
            updateRangeIndicator('dayRangeIndicator', stockData.day_position_percent || 50);
            updateRangeIndicator('fiftyTwoWeekRangeIndicator', stockData.fifty_two_week_position_percent || 50);
            
            // Volume analytics
            if (stockData.volume_analytics) {
                const va = stockData.volume_analytics;
                document.getElementById('currentVolume').textContent = formatVolume(va.current_volume);
                document.getElementById('volume5DayAvg').textContent = formatVolume(va['5_day_avg']);
                document.getElementById('volume10DayAvg').textContent = formatVolume(va['10_day_avg']);
                document.getElementById('volume15DayAvg').textContent = formatVolume(va['15_day_avg']);
                document.getElementById('volume30DayAvg').textContent = formatVolume(va['30_day_avg']);
                document.getElementById('volume3MonthAvg').textContent = formatVolume(va['3_month_avg']);
                document.getElementById('volume6MonthAvg').textContent = formatVolume(va['6_month_avg']);
                document.getElementById('volume1YearAvg').textContent = formatVolume(va['1_year_avg']);
                document.getElementById('volumeTrend').textContent = va.volume_trend || '-';
                document.getElementById('volume30DayRatio').textContent = `${va['30_day_ratio']?.toFixed(2) || '1.00'}x`;
            }
            
            // Technical indicators
            if (stockData.technical_indicators) {
                const ti = stockData.technical_indicators;
                document.getElementById('rsi').textContent = ti.rsi?.toFixed(1) || '-';
                document.getElementById('macd').textContent = ti.macd?.toFixed(4) || '-';
                document.getElementById('sma20').textContent = `$${ti.sma_20?.toFixed(2) || '0.00'}`;
                document.getElementById('sma50').textContent = `$${ti.sma_50?.toFixed(2) || '0.00'}`;
                document.getElementById('vwap').textContent = `$${ti.vwap?.toFixed(2) || '0.00'}`;
            }
            
            // Performance
            if (stockData.price_statistics) {
                const ps = stockData.price_statistics;
                document.getElementById('perf1Day').textContent = formatPerformance(ps['1_day_performance']);
                document.getElementById('perf5Day').textContent = formatPerformance(ps['5_day_performance']);
                document.getElementById('perf1Month').textContent = formatPerformance(ps['1_month_performance']);
                document.getElementById('perf3Month').textContent = formatPerformance(ps['3_month_performance']);
                document.getElementById('perf1Year').textContent = formatPerformance(ps['1_year_performance']);
            }
        }

        function updateRangeIndicator(elementId, percentage) {
            const indicator = document.getElementById(elementId);
            indicator.style.left = `${Math.max(0, Math.min(100, percentage))}%`;
        }

        function formatMarketCap(marketCap) {
            if (!marketCap) return '-';
            if (marketCap >= 1e12) return `$${(marketCap / 1e12).toFixed(2)}T`;
            if (marketCap >= 1e9) return `$${(marketCap / 1e9).toFixed(2)}B`;
            if (marketCap >= 1e6) return `$${(marketCap / 1e6).toFixed(2)}M`;
            return `$${marketCap.toLocaleString()}`;
        }

        function formatVolume(volume) {
            if (!volume) return '-';
            if (volume >= 1e9) return `${(volume / 1e9).toFixed(2)}B`;
            if (volume >= 1e6) return `${(volume / 1e6).toFixed(2)}M`;
            if (volume >= 1e3) return `${(volume / 1e3).toFixed(2)}K`;
            return volume.toLocaleString();
        }

        function formatPerformance(perf) {
            if (perf === undefined || perf === null) return '-';
            const sign = perf >= 0 ? '+' : '';
            return `${sign}${perf.toFixed(2)}%`;
        }

        function loadChart(timeframe, buttonElement = null) {
            currentTimeframe = timeframe;
            
            // Update active button
            document.querySelectorAll('.chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the correct button
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Find button by timeframe if no element provided
                const targetButton = document.querySelector(`[onclick*="${timeframe}"]`);
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }
            
            if (!stockData.chart_data || !stockData.chart_data[timeframe]) {
                console.error('Chart data not available for timeframe:', timeframe);
                return;
            }
            
            const chartData = stockData.chart_data[timeframe];
            createAdvancedChart(chartData);
        }

        function createAdvancedChart(chartData) {
            // Clear existing chart
            const chartContainer = document.getElementById('priceChart');
            chartContainer.innerHTML = '';
            
            // Check if LightweightCharts is available
            if (typeof LightweightCharts === 'undefined') {
                console.warn('LightweightCharts not available, falling back to Chart.js');
                createFallbackChart(chartData);
                return;
            }
            
            try {
                // Create new chart
                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 400,
                    layout: {
                        backgroundColor: 'transparent',
                        textColor: '#ffffff',
                    },
                    grid: {
                        vertLines: {
                            color: '#333333',
                        },
                        horzLines: {
                            color: '#333333',
                        },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#555555',
                    },
                    timeScale: {
                        borderColor: '#555555',
                    },
                });
                
                // Add price series based on chart type
                if (currentChartType === 'candlestick') {
                    createCandlestickSeries(chartData);
                } else {
                    createLineSeries(chartData);
                }
                
                // Add volume series
                if (chartData.volume && chartData.volume.length > 0) {
                    createVolumeSeries(chartData);
                }

                // Handle resize
                window.addEventListener('resize', () => {
                    if (chart) {
                        chart.applyOptions({ width: chartContainer.clientWidth });
                    }
                });
            } catch (error) {
                console.error('Error creating LightweightCharts, falling back to Chart.js:', error);
                createFallbackChart(chartData);
            }
        }

        function createCandlestickSeries(chartData) {
            let candlestickSeries;
            try {
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#00ff00',
                    downColor: '#ff4444',
                    borderDownColor: '#ff4444',
                    borderUpColor: '#00ff00',
                    wickDownColor: '#ff4444',
                    wickUpColor: '#00ff00',
                });
            } catch (error) {
                console.error('Candlestick series error, falling back to line chart:', error);
                // Fallback to line series if candlestick is not available
                candlestickSeries = chart.addLineSeries({
                    color: '#00ff00',
                    lineWidth: 2,
                });
            }

            // Try candlestick data first, fallback to line data
            try {
                const candlestickData = chartData.timestamps.map((timestamp, index) => ({
                    time: timestamp / 1000, // Convert to seconds
                    open: chartData.open[index],
                    high: chartData.high[index],
                    low: chartData.low[index],
                    close: chartData.close[index],
                })).filter(item => item.open && item.high && item.low && item.close);

                candlestickSeries.setData(candlestickData);
            } catch (error) {
                console.error('Error setting candlestick data, using line data:', error);
                // Fallback to line data
                const lineData = chartData.timestamps.map((timestamp, index) => ({
                    time: timestamp / 1000,
                    value: chartData.close[index],
                })).filter(item => item.value);
                
                candlestickSeries.setData(lineData);
            }
        }

        function createLineSeries(chartData) {
            const lineSeries = chart.addLineSeries({
                color: '#00ff00',
                lineWidth: 2,
            });

            const lineData = chartData.timestamps.map((timestamp, index) => ({
                time: timestamp / 1000, // Convert to seconds
                value: chartData.close[index],
            })).filter(item => item.value);

            lineSeries.setData(lineData);
        }

        function createVolumeSeries(chartData) {
            const volumeSeries = chart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });

            const volumeData = chartData.timestamps.map((timestamp, index) => ({
                time: timestamp / 1000, // Convert to seconds
                value: chartData.volume[index],
                color: chartData.close[index] >= chartData.open[index] ? '#00ff0040' : '#ff444440'
            })).filter(item => item.value);

            volumeSeries.setData(volumeData);
        }

        function setChartType(type) {
            currentChartType = type;
            
            // Update active button
            document.querySelectorAll('.chart-type-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (type === 'line') {
                document.getElementById('lineChartBtn').classList.add('active');
            } else {
                document.getElementById('candlestickChartBtn').classList.add('active');
            }
            
            // Reload chart with new type
            if (stockData.chart_data && stockData.chart_data[currentTimeframe]) {
                createAdvancedChart(stockData.chart_data[currentTimeframe]);
            }
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('stockContent').style.display = 'block';
        }

        function showError() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorIndicator').style.display = 'block';
        }

        // Format number function
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Load options summary
        async function loadOptionsSummary() {
            try {
                const response = await fetch(`/api/options/analytics/${symbol}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('optionsSummary').innerHTML = 
                        '<div class="info-row"><span class="info-label">Options data unavailable</span></div>';
                    return;
                }
                
                const analytics = data.analytics || {};
                const summaryHtml = `
                    <div class="info-row">
                        <span class="info-label">Put/Call Ratio:</span>
                        <span class="info-value">${(analytics.put_call_ratio || 0).toFixed(2)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Call Volume:</span>
                        <span class="info-value">${formatNumber(analytics.total_call_volume || 0)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Put Volume:</span>
                        <span class="info-value">${formatNumber(analytics.total_put_volume || 0)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Max Pain:</span>
                        <span class="info-value">$${(analytics.max_pain || 0).toFixed(2)}</span>
                    </div>
                `;
                
                document.getElementById('optionsSummary').innerHTML = summaryHtml;
                
            } catch (error) {
                console.error('Error loading options summary:', error);
                document.getElementById('optionsSummary').innerHTML = 
                    '<div class="info-row"><span class="info-label">Error loading options data</span></div>';
            }
        }

        // Fallback Chart.js implementation
        function createFallbackChart(chartData) {
            const chartContainer = document.getElementById('priceChart');
            chartContainer.innerHTML = '<canvas id="fallbackChart" width="100%" height="400"></canvas>';
            
            const ctx = document.getElementById('fallbackChart').getContext('2d');
            
            // Prepare data for Chart.js
            const labels = chartData.timestamps.map(timestamp => new Date(timestamp));
            const prices = chartData.close;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${symbol} Price`,
                        data: prices,
                        borderColor: '#00ff00',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MMM dd',
                                    week: 'MMM dd',
                                    month: 'MMM yyyy'
                                }
                            },
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#333333'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: '#333333'
                            }
                        }
                    }
                }
            });
        }

        // News functionality
        let newsExpanded = false;
        let newsData = null;

        async function loadNewsSummary() {
            try {
                const response = await fetch(`/api/news/stock/${symbol}?limit=5`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                newsData = data;
                renderNewsSummary(data);
                
            } catch (error) {
                console.error('Error loading news summary:', error);
                document.getElementById('newsSummary').innerHTML = 
                    '<div class="info-row"><span class="info-label">Error loading news data</span></div>';
            }
        }

        function renderNewsSummary(data) {
            const container = document.getElementById('newsSummary');
            
            if (!data.news || data.news.length === 0) {
                container.innerHTML = '<div class="info-row"><span class="info-label">No recent news available</span></div>';
                return;
            }
            
            const newsToShow = newsExpanded ? data.news : data.news.slice(0, 3);
            
            let html = `
                <div class="news-container ${newsExpanded ? 'news-expanded' : 'news-collapsed'}">
            `;
            
            newsToShow.forEach(article => {
                const sentimentClass = getSentimentClass(article.sentiment);
                const sentimentText = getSentimentText(article.sentiment);
                const publishedDate = formatNewsDate(article.published_date);
                
                html += `
                    <div class="news-item">
                        <div class="news-title">
                            <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                                ${article.title}
                            </a>
                        </div>
                        <div class="news-meta">
                            <span class="news-source">${article.source}</span>
                            <div>
                                <span class="sentiment-indicator ${sentimentClass}">${sentimentText}</span>
                                <span class="news-date">${publishedDate}</span>
                            </div>
                        </div>
                        ${article.summary ? `<div class="news-summary">${article.summary}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add summary stats
            if (data.summary) {
                const overallSentiment = getSentimentClass(data.summary.sentiment_score);
                const overallText = getSentimentText(data.summary.sentiment_score);
                
                html += `
                    <div class="mt-2 pt-2" style="border-top: 1px solid #333;">
                        <small class="text-muted">
                            ${data.summary.total_articles} articles  
                            Overall sentiment: <span class="sentiment-indicator ${overallSentiment}">${overallText}</span>
                        </small>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function getSentimentClass(sentiment) {
            if (sentiment > 0.1) return 'sentiment-positive';
            if (sentiment < -0.1) return 'sentiment-negative';
            return 'sentiment-neutral';
        }

        function getSentimentText(sentiment) {
            if (sentiment > 0.3) return 'Very Positive';
            if (sentiment > 0.1) return 'Positive';
            if (sentiment < -0.3) return 'Very Negative';
            if (sentiment < -0.1) return 'Negative';
            return 'Neutral';
        }

        function formatNewsDate(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffHours < 1) return 'Just now';
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                
                return date.toLocaleDateString();
            } catch (error) {
                return 'Recent';
            }
        }

        function toggleNewsExpanded() {
            newsExpanded = !newsExpanded;
            const toggleText = document.getElementById('newsToggleText');
            
            if (newsExpanded) {
                toggleText.textContent = 'Show Less';
                // Load more news if needed
                if (newsData && newsData.news.length <= 3) {
                    loadMoreNews();
                } else if (newsData) {
                    renderNewsSummary(newsData);
                }
            } else {
                toggleText.textContent = 'Show All News';
                if (newsData) {
                    renderNewsSummary(newsData);
                }
            }
        }

        async function loadMoreNews() {
            try {
                const response = await fetch(`/api/news/stock/${symbol}?limit=10`);
                const data = await response.json();
                
                if (!data.error) {
                    newsData = data;
                    renderNewsSummary(data);
                }
            } catch (error) {
                console.error('Error loading more news:', error);
            }
        }

        // Technical Analysis functionality
        let technicalExpanded = false;
        let technicalData = null;

        async function loadTechnicalAnalysis() {
            try {
                const response = await fetch(`/api/technical/${symbol}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                technicalData = data;
                renderTechnicalAnalysis(data);
                
            } catch (error) {
                console.error('Error loading technical analysis:', error);
                document.getElementById('technicalAnalysis').innerHTML = 
                    '<div class="info-row"><span class="info-label">Error loading technical analysis</span></div>';
            }
        }

        function renderTechnicalAnalysis(data) {
            const container = document.getElementById('technicalAnalysis');
            
            if (data.error) {
                container.innerHTML = '<div class="info-row"><span class="info-label">Technical analysis unavailable</span></div>';
                return;
            }
            
            let html = `<div class="${technicalExpanded ? 'technical-expanded' : 'technical-collapsed'}">`;
            
            // Trading Signal Summary
            if (data.trading_signals) {
                const signal = data.trading_signals.overall_signal;
                const strength = data.trading_signals.signal_strength;
                const signalClass = `signal-${signal}`;
                
                html += `
                    <div class="technical-indicator">
                        <span class="indicator-label">Overall Signal:</span>
                        <span class="signal-indicator ${signalClass}">${signal} (${(strength * 100).toFixed(0)}%)</span>
                    </div>
                `;
            }
            
            // Key Technical Indicators
            if (data.technical_indicators) {
                const indicators = data.technical_indicators;
                
                if (indicators.rsi) {
                    const rsiColor = indicators.rsi > 70 ? '#ff4444' : indicators.rsi < 30 ? '#00ff00' : '#fff';
                    html += `
                        <div class="technical-indicator">
                            <span class="indicator-label">RSI (14):</span>
                            <span class="indicator-value" style="color: ${rsiColor}">${indicators.rsi.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (indicators.macd && indicators.macd_signal) {
                    const macdColor = indicators.macd > indicators.macd_signal ? '#00ff00' : '#ff4444';
                    html += `
                        <div class="technical-indicator">
                            <span class="indicator-label">MACD:</span>
                            <span class="indicator-value" style="color: ${macdColor}">${indicators.macd.toFixed(4)}</span>
                        </div>
                    `;
                }
                
                if (indicators.bb_upper && indicators.bb_lower) {
                    html += `
                        <div class="technical-indicator">
                            <span class="indicator-label">Bollinger Bands:</span>
                            <span class="indicator-value">${indicators.bb_lower.toFixed(2)} - ${indicators.bb_upper.toFixed(2)}</span>
                        </div>
                    `;
                }
            }
            
            // Patterns (if expanded)
            if (technicalExpanded && data.pattern_recognition) {
                html += '<div style="margin-top: 15px;"><h6 style="color: #ffa500; margin-bottom: 10px;">Detected Patterns:</h6>';
                
                const patterns = data.pattern_recognition;
                let patternCount = 0;
                
                Object.entries(patterns).forEach(([key, value]) => {
                    if (value === true && key !== 'trend_direction') {
                        const patternName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        html += `<span class="pattern-detected">${patternName}</span>`;
                        patternCount++;
                    }
                });
                
                if (patternCount === 0) {
                    html += '<span style="color: #888; font-style: italic;">No significant patterns detected</span>';
                }
                
                html += '</div>';
            }
            
            // Trend Analysis (if expanded)
            if (technicalExpanded && data.trend_analysis) {
                html += '<div style="margin-top: 15px;"><h6 style="color: #00ccff; margin-bottom: 10px;">Trend Analysis:</h6>';
                
                Object.entries(data.trend_analysis).forEach(([timeframe, trend]) => {
                    if (trend && typeof trend === 'object' && trend.direction) {
                        const trendColor = trend.direction === 'bullish' ? '#00ff00' : '#ff4444';
                        const strengthPercent = (trend.strength * 100).toFixed(0);
                        
                        html += `
                            <div class="technical-indicator">
                                <span class="indicator-label">${timeframe.replace('_', ' ').toUpperCase()}:</span>
                                <span class="indicator-value" style="color: ${trendColor}">
                                    ${trend.direction.toUpperCase()} (${strengthPercent}%)
                                </span>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
            }
            
            // Forecasting (if expanded)
            if (technicalExpanded && data.forecasting) {
                html += '<div style="margin-top: 15px;"><h6 style="color: #ff6600; margin-bottom: 10px;">Price Forecasts:</h6>';
                
                if (data.forecasting.linear_regression) {
                    const forecast = data.forecasting.linear_regression;
                    const avgForecast = forecast.next_5_days.reduce((a, b) => a + b, 0) / forecast.next_5_days.length;
                    const confidence = (forecast.confidence * 100).toFixed(0);
                    
                    html += `
                        <div class="forecast-item">
                            <div style="font-weight: 600; color: #ff6600;">Linear Regression Forecast:</div>
                            <div>5-Day Average Target: $${avgForecast.toFixed(2)}</div>
                            <div>Confidence: ${confidence}%</div>
                        </div>
                    `;
                }
                
                if (data.forecasting.technical_targets) {
                    const targets = data.forecasting.technical_targets;
                    html += `
                        <div class="forecast-item">
                            <div style="font-weight: 600; color: #ff6600;">Technical Targets:</div>
                            ${targets.upside_target ? `<div>Upside Target: $${targets.upside_target.toFixed(2)}</div>` : ''}
                            ${targets.downside_target ? `<div>Downside Target: $${targets.downside_target.toFixed(2)}</div>` : ''}
                        </div>
                    `;
                }
            }
            
            // Support/Resistance (if expanded)
            if (technicalExpanded && data.support_resistance) {
                const sr = data.support_resistance;
                html += '<div style="margin-top: 15px;"><h6 style="color: #00ff88; margin-bottom: 10px;">Support & Resistance:</h6>';
                
                if (sr.nearest_resistance) {
                    html += `
                        <div class="technical-indicator">
                            <span class="indicator-label">Next Resistance:</span>
                            <span class="indicator-value" style="color: #ff4444;">$${sr.nearest_resistance.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (sr.nearest_support) {
                    html += `
                        <div class="technical-indicator">
                            <span class="indicator-label">Next Support:</span>
                            <span class="indicator-value" style="color: #00ff00;">$${sr.nearest_support.toFixed(2)}</span>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleTechnicalExpanded() {
            technicalExpanded = !technicalExpanded;
            const toggleText = document.getElementById('technicalToggleText');
            
            toggleText.textContent = technicalExpanded ? 'Show Less' : 'Show Details';
            
            if (technicalData) {
                renderTechnicalAnalysis(technicalData);
            }
        }

        // Search functionality
        function searchStock() {
            const searchInput = document.getElementById('stockSearch');
            const symbol = searchInput.value.trim().toUpperCase();
            
            if (symbol) {
                // Navigate to the stock detail page
                window.location.href = `/stock/${symbol}`;
            }
        }

        // Handle Enter key in search box
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('stockSearch');
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStock();
                }
            });

            // Auto-suggest functionality (basic)
            searchInput.addEventListener('input', function(e) {
                const value = e.target.value.toUpperCase();
                if (value.length > 0) {
                    // Basic validation for stock symbols
                    e.target.value = value.replace(/[^A-Z]/g, '');
                }
            });

            loadStockData();
            loadOptionsSummary();
            loadNewsSummary();
            loadTechnicalAnalysis();
            loadFundamentalAnalysis();
        });

        // Fundamental Analysis Functions
        let fundamentalExpanded = false;
        let fundamentalData = null;

        async function loadFundamentalAnalysis() {
            try {
                const response = await fetch(`/api/fundamental/${symbol}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                fundamentalData = data;
                updateFundamentalPreview(data);
                
            } catch (error) {
                console.error('Error loading fundamental analysis:', error);
                document.getElementById('fundamentalPE').textContent = 'Error';
                document.getElementById('fundamentalROE').textContent = 'Error';
                document.getElementById('fundamentalGrowth').textContent = 'Error';
                document.getElementById('fundamentalRating').textContent = 'Error';
            }
        }

        function updateFundamentalPreview(data) {
            // Update preview metrics
            const peRatio = data.valuation?.pe_ratio_ttm || 0;
            document.getElementById('fundamentalPE').textContent = peRatio > 0 ? peRatio.toFixed(2) : 'N/A';
            
            const roe = data.profitability?.roe || 0;
            document.getElementById('fundamentalROE').textContent = roe > 0 ? roe.toFixed(1) + '%' : 'N/A';
            
            const growth = data.growth?.revenue_growth_1y || 0;
            const growthElement = document.getElementById('fundamentalGrowth');
            growthElement.textContent = growth !== 0 ? growth.toFixed(1) + '%' : 'N/A';
            growthElement.style.color = growth > 0 ? '#00ff00' : growth < 0 ? '#ff4444' : '#fff';
            
            const recommendation = data.recommendation?.rating || 'N/A';
            const ratingElement = document.getElementById('fundamentalRating');
            ratingElement.textContent = recommendation;
            ratingElement.style.color = data.recommendation?.color || '#fff';
        }

        function toggleFundamentalAnalysis() {
            fundamentalExpanded = !fundamentalExpanded;
            const section = document.getElementById('fundamentalAnalysisSection');
            const icon = document.getElementById('fundamentalExpandIcon');
            
            if (fundamentalExpanded) {
                section.style.display = 'block';
                icon.textContent = '-';
                if (fundamentalData) {
                    renderFundamentalAnalysis(fundamentalData);
                }
            } else {
                section.style.display = 'none';
                icon.textContent = '+';
            }
        }

        function renderFundamentalAnalysis(data) {
            const container = document.getElementById('fundamentalAnalysisContent');
            
            let html = `<div class="fundamental-analysis-detailed">`;
            
            // Company Overview
            html += `
                <div class="fundamental-section">
                    <h6><i class="fas fa-building"></i> Company Overview</h6>
                    <div class="fundamental-grid">
                        <div class="fundamental-item">
                            <span class="label">Company:</span>
                            <span class="value">${data.company_name || 'N/A'}</span>
                        </div>
                        <div class="fundamental-item">
                            <span class="label">Sector:</span>
                            <span class="value">${data.sector || 'N/A'}</span>
                        </div>
                        <div class="fundamental-item">
                            <span class="label">Industry:</span>
                            <span class="value">${data.industry || 'N/A'}</span>
                        </div>
                        <div class="fundamental-item">
                            <span class="label">Market Cap:</span>
                            <span class="value">$${formatLargeNumber(data.market_cap || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Valuation Metrics
            if (data.valuation) {
                html += `
                    <div class="fundamental-section">
                        <h6><i class="fas fa-calculator"></i> Valuation Metrics</h6>
                        <div class="fundamental-grid">
                            <div class="fundamental-item">
                                <span class="label">P/E Ratio (TTM):</span>
                                <span class="value">${data.valuation.pe_ratio_ttm > 0 ? data.valuation.pe_ratio_ttm.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">P/E Forward:</span>
                                <span class="value">${data.valuation.pe_ratio_forward > 0 ? data.valuation.pe_ratio_forward.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Price/Book:</span>
                                <span class="value">${data.valuation.price_to_book > 0 ? data.valuation.price_to_book.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Price/Sales:</span>
                                <span class="value">${data.valuation.price_to_sales > 0 ? data.valuation.price_to_sales.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">PEG Ratio:</span>
                                <span class="value">${data.valuation.peg_ratio > 0 ? data.valuation.peg_ratio.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Dividend Yield:</span>
                                <span class="value">${data.valuation.dividend_yield > 0 ? data.valuation.dividend_yield.toFixed(2) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Profitability Metrics
            if (data.profitability) {
                html += `
                    <div class="fundamental-section">
                        <h6><i class="fas fa-chart-line"></i> Profitability</h6>
                        <div class="fundamental-grid">
                            <div class="fundamental-item">
                                <span class="label">Gross Margin:</span>
                                <span class="value">${data.profitability.gross_margin > 0 ? data.profitability.gross_margin.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Operating Margin:</span>
                                <span class="value">${data.profitability.operating_margin > 0 ? data.profitability.operating_margin.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Profit Margin:</span>
                                <span class="value">${data.profitability.profit_margin > 0 ? data.profitability.profit_margin.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">ROE:</span>
                                <span class="value" style="color: ${data.profitability.roe > 15 ? '#00ff00' : data.profitability.roe > 10 ? '#ffa500' : '#ff4444'}">${data.profitability.roe > 0 ? data.profitability.roe.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">ROA:</span>
                                <span class="value">${data.profitability.roa > 0 ? data.profitability.roa.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">ROIC:</span>
                                <span class="value">${data.profitability.roic > 0 ? data.profitability.roic.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Growth Metrics
            if (data.growth) {
                html += `
                    <div class="fundamental-section">
                        <h6><i class="fas fa-trending-up"></i> Growth Metrics</h6>
                        <div class="fundamental-grid">
                            <div class="fundamental-item">
                                <span class="label">Revenue Growth (1Y):</span>
                                <span class="value" style="color: ${data.growth.revenue_growth_1y > 0 ? '#00ff00' : '#ff4444'}">${data.growth.revenue_growth_1y ? data.growth.revenue_growth_1y.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">EPS Growth (1Y):</span>
                                <span class="value" style="color: ${data.growth.eps_growth_1y > 0 ? '#00ff00' : '#ff4444'}">${data.growth.eps_growth_1y ? data.growth.eps_growth_1y.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Revenue CAGR (3Y):</span>
                                <span class="value">${data.growth.revenue_cagr_3y ? data.growth.revenue_cagr_3y.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Fair Value Analysis
            if (data.fair_value) {
                html += `
                    <div class="fundamental-section">
                        <h6><i class="fas fa-balance-scale"></i> Fair Value Analysis</h6>
                        <div class="fundamental-grid">
                            <div class="fundamental-item">
                                <span class="label">DCF Value:</span>
                                <span class="value">$${data.fair_value.dcf_value ? data.fair_value.dcf_value.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">P/E Based Value:</span>
                                <span class="value">$${data.fair_value.pe_based_value ? data.fair_value.pe_based_value.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Average Fair Value:</span>
                                <span class="value">$${data.fair_value.average_fair_value ? data.fair_value.average_fair_value.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Upside/Downside:</span>
                                <span class="value" style="color: ${data.fair_value.average_upside > 0 ? '#00ff00' : '#ff4444'}">${data.fair_value.average_upside ? data.fair_value.average_upside.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Investment Recommendation
            if (data.recommendation) {
                html += `
                    <div class="fundamental-section">
                        <h6><i class="fas fa-thumbs-up"></i> Investment Recommendation</h6>
                        <div class="recommendation-card" style="background: rgba(${data.recommendation.color === '#00ff00' ? '0,255,0' : data.recommendation.color === '#ff4444' ? '255,68,68' : '255,215,0'}, 0.1); border: 1px solid ${data.recommendation.color};">
                            <div class="recommendation-header">
                                <span class="recommendation-rating" style="color: ${data.recommendation.color}; font-size: 1.2em; font-weight: bold;">
                                    ${data.recommendation.rating}
                                </span>
                                <span class="recommendation-score">Score: ${data.recommendation.score}/100</span>
                            </div>
                            <div class="recommendation-summary" style="margin-top: 10px; color: #ccc;">
                                ${data.recommendation.summary}
                            </div>
                            <div class="recommendation-factors" style="margin-top: 15px;">
                                <strong>Key Factors:</strong>
                                <ul style="margin: 5px 0 0 20px; color: #aaa;">
                                    ${data.recommendation.factors.map(factor => `<li>${factor}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Analyst Data
            if (data.analyst_data && data.analyst_data.consensus) {
                html += `
                    <div class="fundamental-section">
                        <h6><i class="fas fa-users"></i> Analyst Consensus</h6>
                        <div class="fundamental-grid">
                            <div class="fundamental-item">
                                <span class="label">Consensus:</span>
                                <span class="value">${data.analyst_data.consensus}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Total Analysts:</span>
                                <span class="value">${data.analyst_data.total_analysts || 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Price Target:</span>
                                <span class="value">$${data.analyst_data.target_mean ? data.analyst_data.target_mean.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="fundamental-item">
                                <span class="label">Target Upside:</span>
                                <span class="value" style="color: ${data.analyst_data.target_upside > 0 ? '#00ff00' : '#ff4444'}">${data.analyst_data.target_upside ? data.analyst_data.target_upside.toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function formatLargeNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toString();
        }
    </script>
</body>
</html>
