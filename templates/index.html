<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Options Volume Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1400px;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .results-container {
            margin: 20px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .symbol-input {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .symbol-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .scan-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        .scan-btn:disabled {
            opacity: 0.6;
            transform: none;
        }
        .status-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status-card.error {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
        }
        .status-card.running {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        .high-volume {
            font-weight: bold;
            color: #e74c3c;
        }
        .call-badge {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        .put-badge {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .sentiment-bullish {
            color: #27ae60;
            font-weight: bold;
        }
        .sentiment-bearish {
            color: #e74c3c;
            font-weight: bold;
        }
        .sentiment-neutral {
            color: #95a5a6;
            font-weight: normal;
        }
        .options-table {
            font-size: 12px;
            margin-top: 20px;
        }
        .options-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 12px 8px;
            font-weight: 600;
        }
        .options-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .call-row {
            background-color: rgba(40, 167, 69, 0.1);
        }
        .put-row {
            background-color: rgba(220, 53, 69, 0.1);
        }
        .volume-high {
            font-weight: bold;
            color: #dc3545;
        }
        .delta-positive {
            color: #28a745;
            font-weight: 600;
        }
        .delta-negative {
            color: #dc3545;
            font-weight: 600;
        }
        .summary-cards {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            flex: 1;
            min-width: 150px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 2rem;
            font-weight: bold;
        }
        .summary-card p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 120px;
            margin-bottom: 10px;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> Options Volume Scanner</h1>
                <a href="/simulator" class="btn btn-outline-light me-2">
                    <i class="fas fa-calculator"></i> Options Simulator
                </a>
                <a href="/dark-pool" class="btn btn-outline-light me-2">
                    <i class="fas fa-eye"></i> Dark Pool Scanner
                </a>
                <button class="btn btn-outline-light me-2" onclick="togglePortfolio()">
                    <i class="fas fa-wallet"></i> Portfolio <span id="portfolioValue">$100,000</span>
                </button>
                <p class="mb-0">Real-time options activity analysis with Greeks calculations</p>
            </div>

            <div class="control-panel">
                <div class="row">
                    <div class="col-md-3">
                        <label for="symbols" class="form-label"><strong>Stock Symbols</strong></label>
                        <input type="text" id="symbols" class="form-control symbol-input" 
                               placeholder="Enter symbols (e.g., AAPL,TSLA,NVDA)" 
                               value="PLTR">
                        <small class="text-muted">Separate multiple symbols with commas</small>
                    </div>
                    <div class="col-md-3">
                        <label for="volume_threshold" class="form-label"><strong>Volume Threshold</strong></label>
                        <input type="number" id="volume_threshold" class="form-control symbol-input" 
                               value="100" min="1" max="10000">
                        <small class="text-muted">Minimum volume to display</small>
                    </div>
                    <div class="col-md-3">
                        <label for="expiryFilterMain" class="form-label"><strong>Expiry Filter</strong></label>
                        <select id="expiryFilterMain" class="form-select">
                            <option value="all">All Dates</option>
                            <option value="this_week">This Week</option>
                            <option value="this_month">This Month</option>
                            <option value="next_3_months">Next 3 Months</option>
                            <option value="leaps">LEAPS (1+ Years)</option>
                        </select>
                        <small class="text-muted">Filter by expiration</small>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" id="scanBtn" class="btn btn-primary scan-btn w-100" onclick="startScanDirect();">
                            <i class="fas fa-search"></i> Start Scan
                        </button>
                    </div>
                </div>
            </div>

            <div id="statusContainer" style="display: none;">
                <div class="mx-3">
                    <div id="statusCard" class="status-card">
                        <div class="d-flex align-items-center">
                            <div id="statusSpinner" class="spinner me-3" style="display: none;"></div>
                            <div>
                                <strong id="statusText">Ready to scan</strong>
                                <div id="statusProgress" class="small"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Modal -->
            <div class="modal fade" id="portfolioModal" tabindex="-1" aria-labelledby="portfolioModalLabel" aria-hidden="true" style="z-index: 1055;">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content bg-dark" style="position: relative;">
                        <div class="modal-header border-secondary" style="position: relative;">
                            <h5 class="modal-title text-white" id="portfolioModalLabel">
                                <i class="fas fa-wallet"></i> Paper Trading Portfolio
                            </h5>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="closePortfolioModal()" style="position: absolute; right: 15px; top: 15px; z-index: 10000;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h4 id="totalValue">$100,000</h4>
                                            <p class="mb-0">Total Value</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <h4 id="cashBalance">$100,000</h4>
                                            <p class="mb-0">Cash Balance</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <h4 id="totalPnL">$0</h4>
                                            <p class="mb-0">Total P&L</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <h4 id="openPositions">0</h4>
                                            <p class="mb-0">Open Positions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Strike</th>
                                            <th>Exp</th>
                                            <th>Type</th>
                                            <th>Qty</th>
                                            <th>Entry Price</th>
                                            <th>Current Price</th>
                                            <th>P&L</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="portfolioBody">
                                        <tr>
                                            <td colspan="9" class="text-center text-muted">No positions yet. Start paper trading!</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watchlist Section - Always Visible -->
            <div class="mx-3 mb-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-body">
                        <h5 class="card-title text-white mb-3">
                            <i class="fas fa-star me-2"></i>Watchlist
                        </h5>
                        <div id="watchlistContainer" class="mb-3">
                            <div class="d-flex flex-wrap gap-2" id="watchlistSymbols">
                                <!-- Watchlist symbols will be populated here -->
                            </div>
                            <div class="mt-3">
                                <input type="text" id="newSymbolInput" class="form-control form-control-sm d-inline-block" 
                                       style="width: 120px;" placeholder="Add symbol" maxlength="5">
                                <button class="btn btn-primary btn-sm ms-2" onclick="addToWatchlist()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="resultsContainer" class="results-container" style="display: none;">
                <div class="mx-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3><i class="fas fa-table"></i> Options Results</h3>
                        <div class="d-flex gap-2">
                            <span id="totalResults" class="badge bg-info"></span>
                            <span id="totalVolume" class="badge bg-success"></span>
                        </div>
                    </div>
                    
                </div>
                <div id="summaryCards" class="summary-cards"></div>
                
                
                <div class="table-responsive">
                    <table id="resultsTable" class="table table-hover options-table">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;" onclick="sortTable(0)">Symbol <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(1)">Stock Price <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(2)">Diff <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(3)">Exp <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(4)">Strike <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(5)">Type <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(6)">Volume <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(7)">OI <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(8)">Bid <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(9)">Ask <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(10)">Last <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(11)">IV <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(12)">Delta <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(13)">Gamma <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(14)">Theta <i class="fas fa-sort"></i></th>
                                <th style="cursor: pointer;" onclick="sortTable(15)">Rho <i class="fas fa-sort"></i></th>
                                <th>Paper Trade</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let scanInProgress = false;
        let volumeChart = null;
        let currentSortColumn = -1;
        let currentSortDirection = 'asc';
        
        // Paper trading variables
        let portfolio = JSON.parse(localStorage.getItem('paperTradingPortfolio')) || [];
        let cashBalance = parseFloat(localStorage.getItem('paperTradingCash')) || 100000;
        let watchlist = JSON.parse(localStorage.getItem('optionsWatchlist')) || ['SPY', 'QQQ', 'AAPL', 'TSLA', 'NVDA'];

        // Initialize watchlist on page load
        document.addEventListener('DOMContentLoaded', function() {
            renderWatchlist();
        });

        // Watchlist functions
        function renderWatchlist() {
            const container = document.getElementById('watchlistSymbols');
            container.innerHTML = '';
            
            watchlist.forEach(symbol => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-2 mb-2 watchlist-symbol';
                badge.style.cursor = 'pointer';
                badge.innerHTML = `
                    ${symbol}
                    <i class="fas fa-times ms-1" onclick="removeFromWatchlist('${symbol}')" style="cursor: pointer;"></i>
                `;
                badge.onclick = (e) => {
                    if (!e.target.classList.contains('fa-times')) {
                        scanSymbol(symbol);
                    }
                };
                container.appendChild(badge);
            });
        }

        function addToWatchlist() {
            const input = document.getElementById('newSymbolInput');
            const symbol = input.value.trim().toUpperCase();
            
            if (symbol && !watchlist.includes(symbol)) {
                watchlist.push(symbol);
                localStorage.setItem('optionsWatchlist', JSON.stringify(watchlist));
                renderWatchlist();
                input.value = '';
            }
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(s => s !== symbol);
            localStorage.setItem('optionsWatchlist', JSON.stringify(watchlist));
            renderWatchlist();
        }

        function scanSymbol(symbol) {
            // Set the symbol in the input field
            document.getElementById('symbols').value = symbol;
            // Set volume threshold to 100
            document.getElementById('volume_threshold').value = '100';
            // Trigger the scan
            startScanDirect();
        }

        // Allow Enter key to add to watchlist
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newSymbolInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addToWatchlist();
                }
            });
        });

        // Direct scan function
        window.startScanDirect = function() {
            console.log('startScanDirect called');
            const symbols = document.getElementById('symbols').value.trim();
            const volumeThreshold = document.getElementById('volume_threshold').value;
            const expiryFilter = document.getElementById('expiryFilterMain').value;
            
            if (!symbols) {
                alert('Please enter at least one stock symbol');
                return;
            }
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.innerHTML = 'Scanning...';
            
            document.getElementById('statusContainer').style.display = 'block';
            
            // Make API call
            fetch('/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbols: symbols,
                    volume_threshold: parseInt(volumeThreshold),
                    expiry_filter: expiryFilter
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                if (data.error) {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-search"></i> Start Scan';
                } else {
                    pollStatus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start scan: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Start Scan';
            });
        }

        function startScan(symbols, volumeThreshold) {
            console.log('startScan called with:', symbols, volumeThreshold);
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Scanning...';

            document.getElementById('statusContainer').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';

            console.log('Making fetch request to /scan');
            fetch('/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbols: symbols,
                    volume_threshold: volumeThreshold
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.error) {
                    showError(data.error);
                    resetButton();
                } else {
                    // Start polling for status
                    pollStatus();
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showError('Failed to start scan: ' + error.message);
                resetButton();
            });
        }

        function pollStatus() {
            scanInterval = setInterval(() => {
                fetch('/status')
                .then(response => response.json())
                .then(status => {
                    updateStatus(status);
                    
                    if (!status.running) {
                        clearInterval(scanInterval);
                        resetButton();
                        
                        if (status.error) {
                            showError(status.error);
                        } else {
                            loadResults();
                        }
                    }
                })
                .catch(error => {
                    clearInterval(scanInterval);
                    showError('Failed to get status: ' + error.message);
                    resetButton();
                });
            }, 1000);
        }

        function updateStatus(status) {
            const statusCard = document.getElementById('statusCard');
            const statusText = document.getElementById('statusText');
            const statusProgress = document.getElementById('statusProgress');
            const statusSpinner = document.getElementById('statusSpinner');

            if (status.running) {
                statusCard.className = 'status-card running';
                statusText.textContent = 'Scanning in progress...';
                statusProgress.textContent = status.progress;
                statusSpinner.style.display = 'block';
            } else if (status.error) {
                statusCard.className = 'status-card error';
                statusText.textContent = 'Scan failed';
                statusProgress.textContent = status.error;
                statusSpinner.style.display = 'none';
            } else {
                statusCard.className = 'status-card';
                statusText.textContent = 'Scan completed successfully!';
                statusProgress.textContent = status.progress;
                statusSpinner.style.display = 'none';
            }
        }

        function loadResults() {
            fetch('/results')
            .then(response => response.json())
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                showError('Failed to load results: ' + error.message);
            });
        }

        function displayResults(data) {
            // Hide status container and show results
            document.getElementById('statusContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            
            if (!data.options || data.options.length === 0) {
                showError('No unusual options activity found');
                return;
            }

            // Calculate call vs put volume
            const callVolume = data.options.filter(opt => opt.type === 'CALL').reduce((sum, opt) => sum + opt.volume, 0);
            const putVolume = data.options.filter(opt => opt.type === 'PUT').reduce((sum, opt) => sum + opt.volume, 0);
            const callPutRatio = putVolume > 0 ? (callVolume / putVolume).toFixed(2) : 'N/A';
            
            // Show initial summary cards
            updateSummaryCards(data.summary.total_options, data.summary.total_volume, data.summary.calls, data.summary.puts);
            
            // Populate table with options data
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            data.options.forEach(option => {
                const row = document.createElement('tr');
                
                const bidDisplay = option.bid && option.bid > 0 ? `$${option.bid.toFixed(2)}` : 'N/A';
                const askDisplay = option.ask && option.ask > 0 ? `$${option.ask.toFixed(2)}` : 'N/A';
                
                // Try both field names since backend sets both
                const stockPrice = option.current_stock_price || option.current_price;
                
                // Calculate difference between stock price and strike
                const diff = stockPrice && option.strike ? (stockPrice - option.strike).toFixed(2) : 'N/A';
                const diffColor = diff !== 'N/A' ? (parseFloat(diff) >= 0 ? 'text-success' : 'text-danger') : '';
                
                row.innerHTML = `
                    <td>${option.symbol}</td>
                    <td>$${stockPrice ? stockPrice.toFixed(2) : 'N/A'}</td>
                    <td class="${diffColor}">${diff !== 'N/A' ? '$' + diff : 'N/A'}</td>
                    <td>${option.expiration}</td>
                    <td>$${option.strike}</td>
                    <td><span class="badge ${option.type === 'CALL' ? 'bg-success' : 'bg-danger'}">${option.type}</span></td>
                    <td>${option.volume ? option.volume.toLocaleString() : '0'}</td>
                    <td>${option.openInterest ? option.openInterest.toLocaleString() : '0'}</td>
                    <td>${bidDisplay}</td>
                    <td>${askDisplay}</td>
                    <td>$${option.lastPrice ? option.lastPrice.toFixed(2) : '0.00'}</td>
                    <td>${option.impliedVolatility ? (option.impliedVolatility * 100).toFixed(1) + '%' : '0.0%'}</td>
                    <td>${option.delta ? option.delta.toFixed(3) : '0.000'}</td>
                    <td>${option.gamma ? option.gamma.toFixed(3) : '0.000'}</td>
                    <td>${option.theta ? option.theta.toFixed(3) : '0.000'}</td>
                    <td>${option.rho ? option.rho.toFixed(3) : '0.000'}</td>
                    <td>
                        <button class="btn btn-success btn-sm me-1" onclick="paperTrade('${option.symbol}', '${option.strike}', '${option.expiration}', '${option.type}', 'BUY', ${option.ask || option.lastPrice || 0})">
                            <i class="fas fa-plus"></i> Buy
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="paperTrade('${option.symbol}', '${option.strike}', '${option.expiration}', '${option.type}', 'SELL', ${option.bid || option.lastPrice || 0})">
                            <i class="fas fa-minus"></i> Sell
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Create charts
            createVolumeChart(data);
            
            resetButton();
        }

        function resetButton() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Start Scan';
        }

        // Create volume chart with sentiment analysis
        function createVolumeChart(data, callVolume = null, putVolume = null) {
            const canvas = document.getElementById('volumeChart');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            if (volumeChart) {
                volumeChart.destroy();
            }
            
            // Use provided values or calculate from data
            const calls = callVolume !== null ? callVolume : data.options.filter(opt => opt.type === 'CALL').reduce((sum, opt) => sum + (opt.volume || 0), 0);
            const puts = putVolume !== null ? putVolume : data.options.filter(opt => opt.type === 'PUT').reduce((sum, opt) => sum + (opt.volume || 0), 0);
            
            // Calculate sentiment based on call/put ratio
            const totalVolume = calls + puts;
            const callRatio = totalVolume > 0 ? (calls / totalVolume) * 100 : 50;
            const putRatio = totalVolume > 0 ? (puts / totalVolume) * 100 : 50;
            
            let sentiment = '';
            let sentimentColor = '';
            
            if (callRatio > 70) {
                sentiment = 'ðŸŸ¢ VERY BULLISH';
                sentimentColor = '#28a745';
            } else if (callRatio > 60) {
                sentiment = 'ðŸŸ¡ BULLISH';
                sentimentColor = '#ffc107';
            } else if (callRatio >= 40) {
                sentiment = 'âšª NEUTRAL';
                sentimentColor = '#6c757d';
            } else if (callRatio >= 30) {
                sentiment = 'ðŸŸ  BEARISH';
                sentimentColor = '#fd7e14';
            } else {
                sentiment = 'ðŸ”´ VERY BEARISH';
                sentimentColor = '#dc3545';
            }
            
            console.log('Chart data - Calls:', calls, 'Puts:', puts, 'Call Ratio:', callRatio.toFixed(1) + '%', 'Sentiment:', sentiment);
            
            volumeChart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: ['Calls', 'Puts'],
                    datasets: [{
                        data: [calls, puts],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = ((value / totalVolume) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Update the chart card with sentiment
            const chartCard = document.querySelector('.chart-card p');
            if (chartCard) {
                chartCard.innerHTML = `Call vs Put Volume<br><small style="color: ${sentimentColor}; font-weight: bold;">${sentiment}</small>`;
            }
        }

        
        function updateSummaryCards(totalOptions, totalVolume, calls, puts, isFiltered = false) {
            const summaryCards = document.getElementById('summaryCards');
            const optionsLabel = isFiltered ? 'Filtered Options' : 'Total Options';
            
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <h4>${totalOptions}</h4>
                    <p>${optionsLabel}</p>
                </div>
                <div class="summary-card">
                    <h4>${totalVolume.toLocaleString()}</h4>
                    <p>Total Volume</p>
                </div>
                <div class="summary-card">
                    <h4>${calls}</h4>
                    <p>Calls</p>
                </div>
                <div class="summary-card">
                    <h4>${puts}</h4>
                    <p>Puts</p>
                </div>
                <div class="summary-card chart-card">
                    <div class="chart-container">
                        <canvas id="volumeChart" width="150" height="150"></canvas>
                    </div>
                    <p>Call vs Put Volume</p>
                </div>
            `;
            
            // Recreate chart with filtered data
            if (isFiltered) {
                createVolumeChart({options: []}, calls, puts);
            }
        }
        
        function updateFilterSummary(count, volume, type, expiry, minVolume) {
            // Count calls and puts from visible rows
            const visibleRows = document.querySelectorAll('#resultsBody tr[style=""], #resultsBody tr:not([style*="none"])');
            let callCount = 0;
            let putCount = 0;
            
            visibleRows.forEach(row => {
                if (row.cells && row.cells.length > 5) {
                    const optionType = row.cells[5].textContent.trim();
                    if (optionType === 'CALL') callCount++;
                    if (optionType === 'PUT') putCount++;
                }
            });
            
            const summaryCards = document.getElementById('summaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <h4>${count}</h4>
                    <p>Filtered Options</p>
                </div>
                <div class="summary-card">
                    <h4>${volume.toLocaleString()}</h4>
                    <p>Total Volume</p>
                </div>
                <div class="summary-card">
                    <h4>${callCount}</h4>
                    <p>Calls</p>
                </div>
                <div class="summary-card">
                    <h4>${putCount}</h4>
                    <p>Puts</p>
                </div>
                <div class="summary-card">
                    <h4>${type === 'all' ? 'ALL' : type.toUpperCase()}</h4>
                    <p>Type Filter</p>
                </div>
            `;
        }

        // Filter by expiry date (legacy function - keeping for compatibility)
        function filterByExpiry() {
            const expiryFilter = document.getElementById('expiryFilter').value;
            const rows = document.querySelectorAll('#resultsBody tr');
            const today = new Date();
            let visibleCount = 0;
            let totalVolume = 0;
            let callCount = 0;
            let putCount = 0;
            
            rows.forEach(row => {
                const expiryDate = new Date(row.getAttribute('data-expiry'));
                const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                let shouldShow = false;
                
                switch(expiryFilter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'weekly':
                        shouldShow = daysDiff <= 7;
                        break;
                    case 'monthly':
                        shouldShow = daysDiff <= 30;
                        break;
                    case 'quarterly':
                        shouldShow = daysDiff <= 90;
                        break;
                    case 'leaps':
                        shouldShow = daysDiff >= 365;
                        break;
                }
                
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                    
                    // Count volume and types for visible rows
                    const volumeText = row.cells[4].textContent.replace(/,/g, '');
                    totalVolume += parseInt(volumeText) || 0;
                    
                    const optionType = row.getAttribute('data-type');
                    if (optionType === 'CALL') callCount++;
                    if (optionType === 'PUT') putCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update summary cards with filtered data
            const summaryCards = document.getElementById('summaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <h4>${visibleCount}</h4>
                    <p>Filtered Options</p>
                </div>
                <div class="summary-card">
                    <h4>${totalVolume.toLocaleString()}</h4>
                    <p>Total Volume</p>
                </div>
                <div class="summary-card">
                    <h4>${callCount}</h4>
                    <p>Calls</p>
                </div>
                <div class="summary-card">
                    <h4>${putCount}</h4>
                    <p>Puts</p>
                </div>
            `;
        }

        // Sort table functionality
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const table = document.getElementById('resultsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Reset all other column icons
            table.querySelectorAll('th i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            // Toggle sort direction
            const direction = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
            sortDirection[columnIndex] = direction;
            
            // Sort rows based on column content
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();
                
                // Parse numeric columns
                if ([1, 2, 3, 6, 7, 8, 9, 10, 11, 12, 13].includes(columnIndex)) {
                    // Remove $ signs, commas, and % signs, then parse as float
                    aVal = parseFloat(aVal.replace(/[$,%]/g, '')) || 0;
                    bVal = parseFloat(bVal.replace(/[$,%]/g, '')) || 0;
                }
                // Parse date column (Exp)
                else if (columnIndex === 4) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Clear tbody and append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort icon for current column
            const header = table.querySelector(`th:nth-child(${columnIndex + 1}) i`);
            if (header) {
                header.className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
        }

        // Allow Enter key to trigger scan
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('symbols').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleScanClick();
                }
            });
        });

        // Paper trading functions
        function togglePortfolio() {
            updatePortfolioDisplay();
            const modal = new bootstrap.Modal(document.getElementById('portfolioModal'));
            modal.show();
        }

        function closePortfolioModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('portfolioModal'));
            if (modal) {
                modal.hide();
            }
        }

        function paperTrade(symbol, strike, expiration, type, action, price) {
            const quantity = prompt(`Enter quantity for ${action} ${type} ${symbol} ${strike} ${expiration}:`, '1');
            if (!quantity || isNaN(quantity) || quantity <= 0) return;
            
            const qty = parseInt(quantity);
            const totalCost = price * qty * 100; // Options are per 100 shares
            
            if (action === 'BUY' && totalCost > cashBalance) {
                alert('Insufficient cash balance!');
                return;
            }
            
            const position = {
                id: Date.now(),
                symbol,
                strike: parseFloat(strike),
                expiration,
                type,
                action,
                quantity: qty,
                entryPrice: price,
                currentPrice: price,
                timestamp: new Date().toISOString()
            };
            
            if (action === 'BUY') {
                cashBalance -= totalCost;
                portfolio.push(position);
            } else {
                // For SELL, add cash and create short position
                cashBalance += totalCost;
                position.quantity = -qty; // Negative for short
                portfolio.push(position);
            }
            
            savePortfolio();
            updatePortfolioDisplay();
            alert(`${action} ${qty} ${type} ${symbol} ${strike} ${expiration} at $${price.toFixed(2)}`);
        }

        function closePosition(positionId) {
            const position = portfolio.find(p => p.id === positionId);
            if (!position) return;
            
            const currentPrice = position.currentPrice;
            const totalValue = Math.abs(position.quantity) * currentPrice * 100;
            
            if (position.quantity > 0) {
                // Close long position - sell
                cashBalance += totalValue;
            } else {
                // Close short position - buy to cover
                cashBalance -= totalValue;
            }
            
            portfolio = portfolio.filter(p => p.id !== positionId);
            savePortfolio();
            updatePortfolioDisplay();
            alert(`Position closed for $${totalValue.toFixed(2)}`);
        }

        function updatePortfolioDisplay() {
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = '';
            
            if (portfolio.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No positions yet. Start paper trading!</td></tr>';
            } else {
                let totalPnL = 0;
                
                portfolio.forEach(position => {
                    const pnl = (position.currentPrice - position.entryPrice) * position.quantity * 100;
                    totalPnL += pnl;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${position.symbol}</td>
                        <td>$${position.strike}</td>
                        <td>${position.expiration}</td>
                        <td>${position.type}</td>
                        <td>${position.quantity}</td>
                        <td>$${position.entryPrice.toFixed(2)}</td>
                        <td>$${position.currentPrice.toFixed(2)}</td>
                        <td class="${pnl >= 0 ? 'text-success' : 'text-danger'}">$${pnl.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="closePosition(${position.id})">
                                Close
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update summary cards
                document.getElementById('totalPnL').textContent = `$${totalPnL.toFixed(2)}`;
                document.getElementById('totalPnL').parentElement.className = 
                    `card ${totalPnL >= 0 ? 'bg-success' : 'bg-danger'} text-white`;
            }
            
            const totalValue = cashBalance + portfolio.reduce((sum, p) => 
                sum + (p.currentPrice * Math.abs(p.quantity) * 100), 0);
            
            document.getElementById('cashBalance').textContent = `$${cashBalance.toFixed(2)}`;
            document.getElementById('totalValue').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('openPositions').textContent = portfolio.length;
            document.getElementById('portfolioValue').textContent = `$${totalValue.toFixed(0)}`;
        }

        function savePortfolio() {
            localStorage.setItem('paperTradingPortfolio', JSON.stringify(portfolio));
            localStorage.setItem('paperTradingCash', cashBalance.toString());
        }

        // Initialize portfolio display on page load
        document.addEventListener('DOMContentLoaded', function() {
            updatePortfolioDisplay();
        });
    </script>
</body>
</html>
